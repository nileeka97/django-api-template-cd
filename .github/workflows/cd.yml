name: Deploy zip to eb

env:
  # TODO: Configure the following environment variables
  EB_PACKAGE_S3_BUCKET_NAME : "internal-boostnet-backend-dev-deployments"
  EB_APPLICATION_NAME       : "MyApplicationName"
  EB_ENVIRONMENT_NAME       : "MyApplication-Environment"
  DEPLOY_PACKAGE_NAME       : "internal-boostnet-backend-dev-deployment-9d28a559f96e80eb89fe0fcef1f8a3a369fd44d4.zip"
  AWS_REGION_NAME           : "us-east-1"
  EB_PLATFORM_NAME          : "Python"

on:
  push:
    branches:
    - deployment

jobs:
  build:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout source code
      uses: actions/checkout@v2
      
    - name: Configure my AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
         aws-access-key-id    : ${{ secrets.AWS_ACCESS_KEY_ID }}
         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
         aws-region : us-east-1
         
    - name: Create new ElasticBeanstalk Applicaiton Version
      run: |
        aws elasticbeanstalk create-application-version \
        --application-name ${{ env.EB_APPLICATION_NAME }} \
        --source-bundle S3Bucket="${{ env.EB_PACKAGE_S3_BUCKET_NAME }}",S3Key="${{ env.DEPLOY_PACKAGE_NAME }}" \
        --version-label "Ver-${{ github.sha }}" \
        --description "CommitSHA-${{ github.sha }}" \
        --process
    
    - name: Deploy our new Application Version
      run: |
        aws elasticbeanstalk update-environment \
        --environment-name ${{ env.EB_ENVIRONMENT_NAME }} \
        --version-label "Ver-${{ github.sha }}"
    
    - name: Deploy to Elastic Beanstalk
      run: |
        pip install --upgrade awscli awsebcli
        eb init -r ${{ env.AWS_REGION_NAME }} -p ${{ env.EB_PLATFORM_NAME }}
        eb deploy
    
    - name: Print nice message on completion of CD Pipeline
      run: echo "CD Pipeline part finished successfully"
